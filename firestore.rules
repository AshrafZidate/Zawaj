rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if user is accessing their own data
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Helper function to get user data
    function getUserData(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data;
    }

    // Users collection - users can read any profile (for username search) but only write their own
    // Exception: partner connection updates are allowed when accepting/disconnecting a partner
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isOwner(userId) &&
                      request.resource.data.id == userId;
      allow update: if isOwner(userId) &&
                      request.resource.data.id == userId;
      // Allow partner to update this user's partnerIds when accepting a request
      allow update: if isAuthenticated() &&
                      request.resource.data.diff(resource.data).affectedKeys()
                        .hasOnly(['partnerIds', 'partnerId', 'partnerConnectionStatus', 'updatedAt']) &&
                      request.auth.uid in request.resource.data.partnerIds;
      // Allow partner to remove themselves from this user's partnerIds (disconnect/separate)
      allow update: if isAuthenticated() &&
                      request.resource.data.diff(resource.data).affectedKeys()
                        .hasOnly(['partnerIds', 'partnerId', 'partnerConnectionStatus', 'updatedAt']) &&
                      request.auth.uid in resource.data.partnerIds &&
                      !(request.auth.uid in request.resource.data.partnerIds);
      allow delete: if isOwner(userId);
    }

    // Partner requests - authenticated users can read (filtered by query in app)
    match /partnerRequests/{requestId} {
      allow read: if isAuthenticated();

      allow create: if isAuthenticated() &&
                      request.resource.data.senderId == request.auth.uid &&
                      request.resource.data.status == "pending" &&
                      request.resource.data.createdAt is timestamp;

      // Allow update if authenticated and request is pending
      // App logic ensures only receiver can accept/reject
      allow update: if isAuthenticated() &&
                      resource.data.status == "pending" &&
                      request.resource.data.status in ["accepted", "rejected"];

      // Allow partners to update accepted request to separated
      allow update: if isAuthenticated() &&
                      resource.data.status == "accepted" &&
                      request.resource.data.status == "separated" &&
                      (resource.data.senderId == request.auth.uid ||
                       resource.data.receiverId == request.auth.uid);

      allow delete: if false; // Never allow deletion
    }

    // Couples collection - both partners can read/write
    match /couples/{coupleId} {
      allow read: if isAuthenticated() && (
        resource.data.user1Id == request.auth.uid ||
        resource.data.user2Id == request.auth.uid
      );

      allow create: if isAuthenticated() && (
        request.resource.data.user1Id == request.auth.uid ||
        request.resource.data.user2Id == request.auth.uid
      );

      allow update: if isAuthenticated() && (
        resource.data.user1Id == request.auth.uid ||
        resource.data.user2Id == request.auth.uid
      );

      allow delete: if false; // Never allow deletion

      // Responses subcollection
      match /responses/{responseId} {
        allow read, write: if isAuthenticated() && (
          get(/databases/$(database)/documents/couples/$(coupleId)).data.user1Id == request.auth.uid ||
          get(/databases/$(database)/documents/couples/$(coupleId)).data.user2Id == request.auth.uid
        );
      }
    }

    // ===== NEW QUESTION BANK COLLECTIONS =====

    // Topics collection - read-only for authenticated users
    match /topics/{topicId} {
      allow read: if isAuthenticated();
      allow write: if false; // Only via Admin SDK
    }

    // Subtopics collection - read-only for authenticated users
    match /subtopics/{subtopicId} {
      allow read: if isAuthenticated();
      allow write: if false; // Only via Admin SDK
    }

    // Questions collection - read-only for authenticated users
    match /questions/{questionId} {
      allow read: if isAuthenticated();
      allow write: if false; // Only via Admin SDK
    }

    // Partnership progress - partners can read/write their own progress
    // Note: Read is allowed for authenticated users since the partnershipId already contains
    // the user's ID (format: MaleId-FemaleId), so users can only access their own partnerships
    match /partnership_progress/{partnershipId} {
      allow read: if isAuthenticated();

      allow create: if isAuthenticated() &&
                      request.auth.uid in request.resource.data.user_ids;

      allow update: if isAuthenticated() &&
                      request.auth.uid in resource.data.user_ids;

      allow delete: if false;
    }

    // Daily subtopic assignments - partners can read their assignments and update their completion
    match /daily_subtopic_assignments/{assignmentId} {
      allow read: if isAuthenticated();

      // Only Cloud Functions create assignments
      allow create: if false;

      // Users can only update their own completion entry in user_completion map
      // The both_completed, both_completed_at, next_scheduled_date fields are updated via Cloud Functions
      allow update: if isAuthenticated() &&
                      // Only allow updating user_completion with the current user's ID
                      request.resource.data.diff(resource.data).affectedKeys()
                        .hasOnly(['user_completion']) &&
                      // Ensure only the current user's completion is being set
                      request.resource.data.user_completion.diff(resource.data.user_completion).affectedKeys()
                        .hasOnly([request.auth.uid]);

      allow delete: if false;
    }

    // Answers collection - users can read/write their own answers
    match /answers/{answerId} {
      allow read: if isAuthenticated();

      allow create: if isAuthenticated() &&
                      request.resource.data.user_id == request.auth.uid;

      allow update: if isAuthenticated() &&
                      resource.data.user_id == request.auth.uid;

      allow delete: if false;
    }
  }
}
